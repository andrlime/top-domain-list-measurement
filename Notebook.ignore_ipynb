{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "c4516b76-a51f-4774-bd3f-4a81c4e81b65",
   "metadata": {},
   "outputs": [],
   "source": [
    "from pathlib import Path\n",
    "\n",
    "import nest_asyncio\n",
    "import tqdm\n",
    "\n",
    "nest_asyncio.apply()\n",
    "\n",
    "import time\n",
    "\n",
    "import arrow\n",
    "import duckdb\n",
    "import pandas as pd\n",
    "import polars as pl\n",
    "\n",
    "from measurement.lake.measurement_lake_controller import MeasurementLakeController\n",
    "from measurement.util.logger import get_logger\n",
    "\n",
    "log = get_logger(__name__)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "fa5c66d3-1aef-4857-94c3-d97d97719173",
   "metadata": {
    "scrolled": true
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "2026-02-17 20:55:00,999 [\u001b[33mWARNING\u001b[0m / measurement.lake.measurement_lake_controller] 2019/08/31: HTTP 404 — likely gap in data\n",
      "2026-02-17 20:55:01,012 [\u001b[33mWARNING\u001b[0m / measurement.lake.measurement_lake_controller] 2024/10/23: HTTP 404 — likely gap in data\n",
      "2026-02-17 20:55:01,086 [\u001b[33mWARNING\u001b[0m / measurement.lake.measurement_lake_controller] 2019/08/31.csv does not exist\n",
      "2026-02-17 20:55:01,284 [\u001b[33mWARNING\u001b[0m / measurement.lake.measurement_lake_controller] 2024/10/23.csv does not exist\n",
      "2026-02-17 20:55:01,324 [\u001b[32mINFO\u001b[0m / measurement.lake.measurement_lake_controller] to_parquet done: 0 converted, 2920 already parquet, 2 missing\n"
     ]
    }
   ],
   "source": [
    "do_download = True\n",
    "lake = MeasurementLakeController.create(\n",
    "    Path(\"/mnt/apple/cisco-umbrella-2019-2025\"), output=Path(\"/mnt/apple/cisco-umbrella-2019-2025/processed\")\n",
    ")\n",
    "if do_download:\n",
    "    await lake.download(arrow.get(\"2018-01-01\"), arrow.get(\"2025-12-31\"))\n",
    "    lake.to_parquet(arrow.get(\"2018-01-01\"), arrow.get(\"2025-12-31\"))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "940f5733-b2cb-44cc-9704-48cf1b268d4d",
   "metadata": {},
   "outputs": [],
   "source": [
    "def extract_domain(lake, domain, start_year=2018, end_year=2025):\n",
    "    for year in tqdm.tqdm(range(start_year, end_year + 1), desc=domain, leave=False):\n",
    "        startdate = f\"{year}-01-01\"\n",
    "        enddate = f\"{year}-12-31\"\n",
    "\n",
    "        view = lake.query(f\"\"\"\n",
    "            SELECT domain, rank, date\n",
    "            FROM raw\n",
    "            WHERE date BETWEEN '{startdate}' AND '{enddate}'\n",
    "        \"\"\")\n",
    "\n",
    "        df = view.query(\n",
    "            \"view\",\n",
    "            f\"\"\"\n",
    "            SELECT date, MIN(rank) AS best_rank, COUNT(*) AS num_subdomains\n",
    "            FROM view\n",
    "            WHERE domain LIKE '%.{domain}' OR domain = '{domain}'\n",
    "            GROUP BY date\n",
    "            ORDER BY date\n",
    "        \"\"\",\n",
    "        ).df()\n",
    "\n",
    "        lake.save(df, domain, year)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "f261e3c0-f41a-4cf8-9b72-a2625eddd015",
   "metadata": {},
   "outputs": [
    {
     "ename": "SyntaxError",
     "evalue": "incomplete input (334239384.py, line 15)",
     "output_type": "error",
     "traceback": [
      "  \u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[6]\u001b[39m\u001b[32m, line 15\u001b[39m\n\u001b[31m    \u001b[39m\u001b[31mextract_domain(lake, domain, START_YEAR, END_YEAR)\u001b[39m\n                                                      ^\n\u001b[31mSyntaxError\u001b[39m\u001b[31m:\u001b[39m incomplete input\n"
     ]
    }
   ],
   "source": [
    "START_YEAR = 2018\n",
    "END_YEAR = 2025\n",
    "\n",
    "domains = [\n",
    "    \"google.com\",\n",
    "    \"zoom.us\",\n",
    "    \"teams.microsoft.com\",\n",
    "    \"sharepoint.com\",\n",
    "    \"office.com\",\n",
    "    \"slack.com\",\n",
    "    \"linkedin.com\",\n",
    "    \"tumblr.com\",\n",
    "    \"twitch.tv\",\n",
    "    \"netflix.com\",\n",
    "    \"reddit.com\",\n",
    "    \"steampowered.com\",\n",
    "    \"stackoverflow.com\",\n",
    "    \"quora.com\",\n",
    "    \"w3schools.com\",\n",
    "    \"chegg.com\",\n",
    "    \"stackexchange.com\",\n",
    "    \"openai.com\",\n",
    "    \"claude.ai\",\n",
    "    \"deepseek.com\",\n",
    "    \"blogspot.com\",\n",
    "    \"wordpress.com\",\n",
    "    \"nessus.org\",\n",
    "    \"nflxso.net\",\n",
    "    \"ampproject.org\",\n",
    "]\n",
    "\n",
    "for domain in tqdm.tqdm(domains):\n",
    "    extract_domain(lake, domain, START_YEAR, END_YEAR)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "69f7ca44-56a6-424d-8a64-9f9fce4dcaed",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
